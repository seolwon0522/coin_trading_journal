{% extends "base.html" %} {% block title %}ëŒ€ì‹œë³´ë“œ - ML ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§{%
endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-tachometer-alt me-2"></i>ML ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>
  <div class="text-muted">
    <i class="fas fa-clock me-1"></i>
    ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:
    <span id="last-update">{{ data.last_update or 'ë¡œë”© ì¤‘...' }}</span>
  </div>
</div>

<!-- 1ë…„ì¹˜ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ íŒ¨ë„ -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow">
      <div
        class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
      >
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-rocket me-2"></i>1ë…„ì¹˜ ìë™ë§¤ë§¤ ë°±í…ŒìŠ¤íŠ¸ & ML í›ˆë ¨
        </h6>
        <div class="dropdown no-arrow">
          <a
            class="dropdown-toggle"
            href="#"
            role="button"
            id="backtestDropdown"
            data-bs-toggle="dropdown"
            aria-haspopup="true"
            aria-expanded="false"
          >
            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
          </a>
          <div
            class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
            aria-labelledby="backtestDropdown"
          >
            <div class="dropdown-header">ë°±í…ŒìŠ¤íŠ¸ ì˜µì…˜:</div>
            <a class="dropdown-item" href="#" onclick="showBacktestSettings()"
              >ê³ ê¸‰ ì„¤ì •</a
            >
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#" onclick="viewBacktestHistory()"
              >ì‹¤í–‰ ê¸°ë¡</a
            >
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- ì‹¤í–‰ ì»¨íŠ¸ë¡¤ -->
          <div class="col-md-4">
            <div class="form-group">
              <label for="symbol-select" class="form-label">ê±°ë˜ ì‹¬ë³¼</label>
              <select class="form-select" id="symbol-select">
                <option value="BTCUSDT" selected>BTC/USDT</option>
                <option value="ETHUSDT">ETH/USDT</option>
                <option value="BNBUSDT">BNB/USDT</option>
              </select>
            </div>
            <div class="form-group">
              <label for="chunk-size" class="form-label">ì²­í¬ í¬ê¸° (ì¼)</label>
              <input
                type="number"
                class="form-control"
                id="chunk-size"
                value="30"
                min="7"
                max="90"
              />
              <small class="form-text text-muted"
                >ì‘ì„ìˆ˜ë¡ ë©”ëª¨ë¦¬ íš¨ìœ¨ì , í´ìˆ˜ë¡ ë¹ ë¦„</small
              >
            </div>
            <div class="form-group mb-3">
              <label for="timeframe-select" class="form-label"
                >ì‹œê°„ í”„ë ˆì„</label
              >
              <select class="form-select" id="timeframe-select">
                <option value="1m" selected>1ë¶„ë´‰</option>
                <option value="5m">5ë¶„ë´‰</option>
                <option value="1h">1ì‹œê°„ë´‰</option>
              </select>
            </div>

            <!-- ì‹¤í–‰ ë²„íŠ¼ë“¤ -->
            <div class="d-grid gap-2">
              <button
                type="button"
                class="btn btn-primary btn-lg"
                id="start-backtest-btn"
                onclick="startBacktest()"
              >
                <i class="fas fa-play me-2"></i>1ë…„ì¹˜ ë°±í…ŒìŠ¤íŠ¸ ì‹œì‘
              </button>
              <button
                type="button"
                class="btn btn-warning"
                id="stop-backtest-btn"
                onclick="stopBacktest()"
                style="display: none"
              >
                <i class="fas fa-stop me-2"></i>ì¤‘ë‹¨
              </button>
            </div>
          </div>

          <!-- ì§„í–‰ ìƒí™© -->
          <div class="col-md-8">
            <div id="backtest-status" style="display: none">
              <h6 class="text-primary mb-3">
                <i class="fas fa-chart-line me-2"></i>ì§„í–‰ ìƒí™©
                <span class="badge bg-info ms-2" id="status-badge"
                  >ì¤€ë¹„ ì¤‘</span
                >
              </h6>

              <!-- ì§„í–‰ë¥  í‘œì‹œ -->
              <div class="mb-3">
                <div
                  class="d-flex justify-content-between align-items-center mb-1"
                >
                  <span class="small text-muted">ì „ì²´ ì§„í–‰ë¥ </span>
                  <span class="small text-muted" id="progress-percent">0%</span>
                </div>
                <div class="progress">
                  <div
                    class="progress-bar progress-bar-striped progress-bar-animated"
                    id="progress-bar"
                    role="progressbar"
                    style="width: 0%"
                    aria-valuenow="0"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>
              </div>

              <!-- í˜„ì¬ ë‹¨ê³„ -->
              <div class="alert alert-info mb-3" id="current-step">
                <i class="fas fa-info-circle me-2"></i>
                <span id="step-text">ì¤€ë¹„ ì¤‘...</span>
              </div>

              <!-- ì‹¤ì‹œê°„ ë¡œê·¸ -->
              <div class="card">
                <div class="card-header py-2">
                  <h6 class="m-0 text-primary">
                    <i class="fas fa-terminal me-2"></i>ì‹¤ì‹œê°„ ë¡œê·¸
                    <button
                      class="btn btn-sm btn-outline-secondary float-end"
                      onclick="clearLogs()"
                    >
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </h6>
                </div>
                <div class="card-body p-2">
                  <div
                    id="backtest-logs"
                    style="
                      height: 150px;
                      overflow-y: auto;
                      font-family: monospace;
                      font-size: 0.9rem;
                      background: #f8f9fa;
                      padding: 10px;
                      border-radius: 4px;
                    "
                  >
                    <!-- ë¡œê·¸ ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                  </div>
                </div>
              </div>
            </div>

            <!-- ê²°ê³¼ í‘œì‹œ -->
            <div id="backtest-result" style="display: none">
              <h6 class="text-success mb-3">
                <i class="fas fa-check-circle me-2"></i>ë°±í…ŒìŠ¤íŠ¸ ì™„ë£Œ!
              </h6>
              <div class="row">
                <div class="col-6">
                  <div class="card bg-light">
                    <div class="card-body text-center">
                      <h5 class="card-title text-primary" id="result-trades">
                        -
                      </h5>
                      <p class="card-text small text-muted">ìƒì„±ëœ ê±°ë˜</p>
                    </div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="card bg-light">
                    <div class="card-body text-center">
                      <h5 class="card-title text-success" id="result-r2">-</h5>
                      <p class="card-text small text-muted">ëª¨ë¸ RÂ² ìŠ¤ì½”ì–´</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-6">
                  <div class="card bg-light">
                    <div class="card-body text-center">
                      <h5 class="card-title text-info" id="result-time">-</h5>
                      <p class="card-text small text-muted">ì‹¤í–‰ ì‹œê°„</p>
                    </div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="card bg-light">
                    <div class="card-body text-center">
                      <h5 class="card-title text-warning" id="result-winrate">
                        -
                      </h5>
                      <p class="card-text small text-muted">ìŠ¹ë¥ </p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <button
                  class="btn btn-success me-2"
                  onclick="viewDetailedResults()"
                >
                  <i class="fas fa-chart-bar me-2"></i>ìƒì„¸ ê²°ê³¼ ë³´ê¸°
                </button>
                <button
                  class="btn btn-outline-primary"
                  onclick="downloadReport()"
                >
                  <i class="fas fa-download me-2"></i>ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ì£¼ìš” ì§€í‘œ ì¹´ë“œ -->
<div class="row mb-4">
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card metric-card border-left-primary shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div
              class="text-xs font-weight-bold text-primary text-uppercase mb-1"
            >
              ëª¨ë¸ ê±´ê°•ì„±
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              <span id="health-score"
                >{{ data.health_check.score if data.health_check else 'N/A'
                }}</span
              >/100
            </div>
            <small class="text-muted">
              ìƒíƒœ:
              <span
                id="health-status"
                class="status-{{ data.health_check.status if data.health_check else 'unknown' }}"
              >
                {{ data.health_check.status if data.health_check else 'Unknown'
                }}
              </span>
            </small>
          </div>
          <div class="col-auto">
            <i class="fas fa-heartbeat fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card metric-card border-left-success shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div
              class="text-xs font-weight-bold text-success text-uppercase mb-1"
            >
              ìµœì‹  RÂ² ì ìˆ˜
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {% if data.health_check and data.health_check.latest_performance
              %} {{ "%.4f"|format(data.health_check.latest_performance.r2_score)
              }} {% else %} N/A {% endif %}
            </div>
            <small class="text-muted">
              {% if data.performance_summary and
              data.performance_summary.trend_analysis %} {{
              data.performance_summary.trend_analysis.r2_trend }} {% endif %}
            </small>
          </div>
          <div class="col-auto">
            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card metric-card border-left-info shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
              ì´ í‰ê°€ íšŸìˆ˜
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ data.total_evaluations or 0 }}
            </div>
            <small class="text-muted">
              ìµœê·¼ 7ì¼: {% if data.performance_summary and
              data.performance_summary.total_evaluations %} {{
              data.performance_summary.total_evaluations }}ê±´ {% else %} 0ê±´ {%
              endif %}
            </small>
          </div>
          <div class="col-auto">
            <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card metric-card border-left-warning shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div
              class="text-xs font-weight-bold text-warning text-uppercase mb-1"
            >
              ì´ ì•Œë¦¼
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ data.total_alerts or 0 }}
            </div>
            <small class="text-muted">
              ì‹¬ê°: {% if data.performance_summary and
              data.performance_summary.alerts_summary %} {{
              data.performance_summary.alerts_summary.critical_alerts }}ê±´ {%
              else %} 0ê±´ {% endif %}
            </small>
          </div>
          <div class="col-auto">
            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ì„±ëŠ¥ ì°¨íŠ¸ ë° ìµœê·¼ ì•Œë¦¼ -->
<div class="row">
  <!-- ì„±ëŠ¥ íŠ¸ë Œë“œ ì°¨íŠ¸ -->
  <div class="col-xl-8 col-lg-7">
    <div class="card shadow mb-4">
      <div
        class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
      >
        <h6 class="m-0 font-weight-bold text-primary">ì„±ëŠ¥ íŠ¸ë Œë“œ</h6>
        <div class="dropdown no-arrow">
          <select
            id="chart-period"
            class="form-select form-select-sm"
            onchange="updateChart()"
          >
            <option value="7">ìµœê·¼ 7ì¼</option>
            <option value="30" selected>ìµœê·¼ 30ì¼</option>
            <option value="90">ìµœê·¼ 90ì¼</option>
          </select>
        </div>
      </div>
      <div class="card-body">
        <div class="chart-area">
          <canvas id="performanceChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ìµœê·¼ ì•Œë¦¼ -->
  <div class="col-xl-4 col-lg-5">
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">ìµœê·¼ ì•Œë¦¼</h6>
      </div>
      <div class="card-body">
        {% if data.recent_alerts %}
        <div class="list-group list-group-flush">
          {% for alert in data.recent_alerts[-5:] %}
          <div class="list-group-item alert-{{ alert.severity }} px-0">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">
                {% if alert.severity == 'critical' %}
                <i class="fas fa-times-circle text-danger"></i>
                {% elif alert.severity == 'high' %}
                <i class="fas fa-exclamation-circle text-warning"></i>
                {% elif alert.severity == 'medium' %}
                <i class="fas fa-info-circle text-info"></i>
                {% else %}
                <i class="fas fa-check-circle text-success"></i>
                {% endif %} {{ alert.alert_type|title }}
              </h6>
              <small>{{ alert.timestamp[:16] }}</small>
            </div>
            <p class="mb-1">{{ alert.message }}</p>
            <small class="text-muted">{{ alert.recommendation }}</small>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
          <i class="fas fa-bell-slash fa-2x mb-3"></i>
          <p>ìµœê·¼ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
        {% endif %}

        <div class="mt-3">
          <a
            href="{{ url_for('alerts') }}"
            class="btn btn-primary btn-sm w-100"
          >
            <i class="fas fa-eye me-1"></i>ëª¨ë“  ì•Œë¦¼ ë³´ê¸°
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ì„±ëŠ¥ ìš”ì•½ ì •ë³´ -->
{% if data.performance_summary and data.performance_summary.performance_metrics
%}
<div class="row">
  <div class="col-12">
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">ìµœê·¼ 7ì¼ ì„±ëŠ¥ ìš”ì•½</h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <div class="text-center">
              <div class="h4 text-primary">
                {{
                "%.4f"|format(data.performance_summary.performance_metrics.avg_r2)
                }}
              </div>
              <div class="text-muted">í‰ê·  RÂ²</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <div class="h4 text-success">
                {{
                "%.4f"|format(data.performance_summary.performance_metrics.avg_rmse)
                }}
              </div>
              <div class="text-muted">í‰ê·  RMSE</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <div class="h4 text-info">
                {{
                "%.4f"|format(data.performance_summary.performance_metrics.max_r2)
                }}
              </div>
              <div class="text-muted">ìµœëŒ€ RÂ²</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <div class="h4 text-warning">
                {{
                "%.4f"|format(data.performance_summary.performance_metrics.min_rmse)
                }}
              </div>
              <div class="text-muted">ìµœì†Œ RMSE</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- ì¶”ì²œì‚¬í•­ -->
{% if data.performance_summary and data.performance_summary.recommendations %}
<div class="row">
  <div class="col-12">
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-lightbulb me-1"></i>ì¶”ì²œì‚¬í•­
        </h6>
      </div>
      <div class="card-body">
        <ul class="list-unstyled mb-0">
          {% for recommendation in data.performance_summary.recommendations %}
          <li class="mb-2">
            <i class="fas fa-arrow-right text-primary me-2"></i>
            {{ recommendation }}
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endif %} {% endblock %} {% block scripts %}
<script>
  // ì„±ëŠ¥ ì°¨íŠ¸ ì„¤ì •
  let performanceChart;
  let pnlChart;

  function initChart() {
    const ctx = document.getElementById("performanceChart").getContext("2d");

    // ì´ˆê¸° ë¹ˆ ì°¨íŠ¸
    performanceChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "RÂ² Score",
            data: [],
            borderColor: "rgb(75, 192, 192)",
            backgroundColor: "rgba(75, 192, 192, 0.1)",
            tension: 0.1,
            yAxisID: "y",
          },
          {
            label: "RMSE",
            data: [],
            borderColor: "rgb(255, 99, 132)",
            backgroundColor: "rgba(255, 99, 132, 0.1)",
            tension: 0.1,
            yAxisID: "y1",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: "index",
          intersect: false,
        },
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: "ì‹œê°„",
            },
          },
          y: {
            type: "linear",
            display: true,
            position: "left",
            title: {
              display: true,
              text: "RÂ² Score",
            },
            min: 0,
            max: 1,
          },
          y1: {
            type: "linear",
            display: true,
            position: "right",
            title: {
              display: true,
              text: "RMSE",
            },
            grid: {
              drawOnChartArea: false,
            },
          },
        },
        plugins: {
          title: {
            display: true,
            text: "ëª¨ë¸ ì„±ëŠ¥ íŠ¸ë Œë“œ",
          },
          legend: {
            display: true,
            position: "top",
          },
        },
      },
    });

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    updateChart();
  }

  // ì†ìµ ì°¨íŠ¸ ì´ˆê¸°í™”
  function initPnlChart() {
    const ctx = document.getElementById("pnlChart").getContext("2d");
    pnlChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "PnL ($)",
            data: [],
            borderColor: "rgb(99, 132, 255)",
            backgroundColor: "rgba(99, 132, 255, 0.1)",
            tension: 0.1,
            yAxisID: "y",
          },
          {
            label: "ëˆ„ì  PnL ($)",
            data: [],
            borderColor: "rgb(54, 162, 235)",
            backgroundColor: "rgba(54, 162, 235, 0.1)",
            tension: 0.1,
            yAxisID: "y1",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: { autoSkip: true, maxTicksLimit: 10 },
            grid: { display: false },
          },
          y: {
            position: "left",
            title: { display: true, text: "PnL ($)" },
            ticks: { maxTicksLimit: 6 },
          },
          y1: {
            position: "right",
            title: { display: true, text: "ëˆ„ì  PnL ($)" },
            grid: { drawOnChartArea: false },
            ticks: { maxTicksLimit: 6 },
          },
        },
        plugins: {
          legend: { position: "top" },
          title: { display: true, text: "ìµœê·¼ ë°±í…ŒìŠ¤íŠ¸ ì†ìµ ì¶”ì´" },
          decimation: { enabled: true, algorithm: "min-max" },
        },
      },
    });
    updatePnlChart();
  }

  function updatePnlChart() {
    const agg = document.getElementById("aggToggle")?.checked ? "daily" : "raw";
    const days = document.getElementById("pnl-period")?.value || 30;
    // í•œê¸€ ì£¼ì„: ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¿¼ë¦¬ ì¶”ê°€ ë° no-store ì˜µì…˜ ì‚¬ìš©
    // í•œê¸€ ì£¼ì„: ì¹´ë“œ íƒ€ì´í‹€ì´ 'ìµœê·¼ ë°±í…ŒìŠ¤íŠ¸'ì´ë¯€ë¡œ ê¸°ë³¸ ìš”ì²­ì€ CSV ìµœì‹  ê¸°ì¤€ìœ¼ë¡œ ê°•ì œ
    // í•œê¸€ ì£¼ì„: ëª¨ë“  ê¸°ê°„ì—ì„œ CSV ë³‘í•© ë°ì´í„° ì‚¬ìš©
    const mode = "all";
    fetch(
      `/api/pnl_history?agg=${agg}&days=${days}&source=csv&mode=${mode}&_ts=${Date.now()}`,
      {
        cache: "no-store",
      }
    )
      .then((res) => {
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        return res.json();
      })
      .then((data) => {
        if (!data.success) {
          console.error("API ì‘ë‹µ ì˜¤ë¥˜:", data.error);
          return;
        }
        const c = data.chart_data;

        // í•œê¸€ ì£¼ì„: ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
        if (!c.timestamps || c.timestamps.length === 0) {
          console.log("PnL ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤");
          // ë¹ˆ ì°¨íŠ¸ í‘œì‹œ
          pnlChart.data.labels = [];
          pnlChart.data.datasets[0].data = [];
          pnlChart.data.datasets[1].data = [];
          pnlChart.update();
          return;
        }

        const labels = c.timestamps.map((ts) =>
          new Date(ts).toLocaleString("ko-KR")
        );
        pnlChart.data.labels = labels;
        pnlChart.data.datasets[0].data = c.pnl;
        pnlChart.data.datasets[1].data = c.cum_pnl;

        // í•œê¸€ ì£¼ì„: ë°ì´í„° í¬ì¸íŠ¸ê°€ 2ê°œ ë¯¸ë§Œì´ë©´ ì ì„ í¬ê²Œ ë³´ì—¬ ê°€ì‹œì„± í™•ë³´
        const isSparse = labels.length < 2;
        pnlChart.data.datasets.forEach((ds) => {
          ds.pointRadius = isSparse ? 5 : 3;
          ds.pointHoverRadius = isSparse ? 7 : 4;
          ds.showLine = !isSparse; // ì ë§Œ í‘œì‹œ
        });
        pnlChart.update();

        const src = document.getElementById("pnl-source");
        if (src)
          src.textContent = c.source_file ? `íŒŒì¼: ${c.source_file}` : "";

        // ì§€í‘œ ì—…ë°ì´íŠ¸
        const m = data.metrics || {};
        document.getElementById("m-trades").textContent = m.trades ?? "-";
        document.getElementById("m-total").textContent = (
          m.total_pnl ?? 0
        ).toLocaleString("en-US");
        document.getElementById("m-win").textContent = m.win_rate
          ? `${m.win_rate}%`
          : "-";
        document.getElementById("m-avg").textContent = (m.avg_pnl ?? 0).toFixed(
          2
        );
        document.getElementById("m-mdd").textContent = m.max_drawdown_pct
          ? `${m.max_drawdown_pct}%`
          : "-";
        document.getElementById("m-cagr-sharpe").textContent =
          `${m.cagr_pct ?? 0}% / ${m.sharpe ?? 0}`;

        console.log(
          `PnL ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${c.timestamps.length}ê°œ ë°ì´í„°í¬ì¸íŠ¸`
        );
      })
      .catch((err) => {
        console.error("PnL ì°¨íŠ¸ ê°±ì‹  ì‹¤íŒ¨:", err);
        // ì—ëŸ¬ í‘œì‹œë¥¼ ìœ„í•œ UI ì—…ë°ì´íŠ¸ë„ ê°€ëŠ¥
      });
  }

  // í•™ìŠµ ê°œì„ ì  ì°¨íŠ¸ ì´ˆê¸°í™”
  function initLearningChart() {
    const ctx = document.getElementById("learningChart").getContext("2d");
    window.learningChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "RÂ² Score",
            data: [],
            borderColor: "rgba(75, 192, 192, 1)",
            backgroundColor: "rgba(75, 192, 192, 0.2)",
            tension: 0.1,
          },
          {
            label: "ìŠ¹ë¥  (%)",
            data: [],
            borderColor: "rgba(255, 99, 132, 1)",
            backgroundColor: "rgba(255, 99, 132, 0.2)",
            tension: 0.1,
            yAxisID: "y1",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { title: { display: true, text: "í•™ìŠµ ì‚¬ì´í´" } },
          y: {
            title: { display: true, text: "RÂ² Score" },
            min: 0.99,
            max: 1.0,
          },
          y1: {
            type: "linear",
            display: true,
            position: "right",
            title: { display: true, text: "ìŠ¹ë¥  (%)" },
            grid: { drawOnChartArea: false },
          },
        },
        plugins: {
          title: { display: true, text: "í•™ìŠµ ì‚¬ì´í´ë³„ ì„±ëŠ¥ ê°œì„ " },
        },
      },
    });
  }

  // í”¼ì²˜ ì¤‘ìš”ë„ ì°¨íŠ¸ ì´ˆê¸°í™”
  function initFeatureChart() {
    const ctx = document.getElementById("featureChart").getContext("2d");
    window.featureChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "PnL Ratio",
            data: [],
            borderColor: "rgba(255, 206, 86, 1)",
            backgroundColor: "rgba(255, 206, 86, 0.2)",
            tension: 0.1,
          },
          {
            label: "Market Condition",
            data: [],
            borderColor: "rgba(54, 162, 235, 1)",
            backgroundColor: "rgba(54, 162, 235, 0.2)",
            tension: 0.1,
          },
          {
            label: "Volatility",
            data: [],
            borderColor: "rgba(153, 102, 255, 1)",
            backgroundColor: "rgba(153, 102, 255, 0.2)",
            tension: 0.1,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { title: { display: true, text: "í•™ìŠµ ì‚¬ì´í´" } },
          y: {
            title: { display: true, text: "í”¼ì²˜ ì¤‘ìš”ë„" },
            min: 0,
            max: 0.5,
          },
        },
        plugins: {
          title: { display: true, text: "ì£¼ìš” í”¼ì²˜ ì¤‘ìš”ë„ ë³€í™”" },
        },
      },
    });
  }

  // í•™ìŠµ ê°œì„ ì  ë°ì´í„° ì—…ë°ì´íŠ¸
  function updateLearningChart() {
    fetch("/api/learning_improvements")
      .then((res) => res.json())
      .then((data) => {
        if (Array.isArray(data) && data.length > 0) {
          const labels = data.map((cycle) => `ì‚¬ì´í´ ${cycle.cycle}`);
          const r2_scores = data.map(
            (cycle) => cycle.model_metrics?.test_r2 || 0
          );
          const win_rates = data.map(
            (cycle) => cycle.backtest_summary?.win_rate || 0
          );

          learningChart.data.labels = labels;
          learningChart.data.datasets[0].data = r2_scores;
          learningChart.data.datasets[1].data = win_rates;
          learningChart.update();
        }
      })
      .catch((err) => console.error("í•™ìŠµ ì°¨íŠ¸ ê°±ì‹  ì‹¤íŒ¨:", err));
  }

  // í”¼ì²˜ ì¤‘ìš”ë„ ë°ì´í„° ì—…ë°ì´íŠ¸
  function updateFeatureChart() {
    fetch("/api/feature_importance_trend")
      .then((res) => res.json())
      .then((data) => {
        if (Array.isArray(data) && data.length > 0) {
          const labels = data.map((cycle) => `ì‚¬ì´í´ ${cycle.cycle}`);
          const pnl_ratios = data.map((cycle) => cycle.pnl_ratio || 0);
          const market_conditions = data.map(
            (cycle) => cycle.market_condition || 0
          );
          const volatilities = data.map((cycle) => cycle.volatility || 0);

          featureChart.data.labels = labels;
          featureChart.data.datasets[0].data = pnl_ratios;
          featureChart.data.datasets[1].data = market_conditions;
          featureChart.data.datasets[2].data = volatilities;
          featureChart.update();
        }
      })
      .catch((err) => console.error("í”¼ì²˜ ì°¨íŠ¸ ê°±ì‹  ì‹¤íŒ¨:", err));
  }

  function updateChart() {
    const period = document.getElementById("chart-period").value;

    fetch(`/api/performance_history?days=${period}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const chartData = data.chart_data;

          // íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì½ê¸° ì‰¬ìš´ í˜•íƒœë¡œ ë³€í™˜
          const labels = chartData.timestamps.map((ts) => {
            const date = new Date(ts);
            return (
              date.toLocaleDateString("ko-KR") +
              " " +
              date.toLocaleTimeString("ko-KR", {
                hour: "2-digit",
                minute: "2-digit",
              })
            );
          });

          performanceChart.data.labels = labels;
          performanceChart.data.datasets[0].data = chartData.r2_scores;
          performanceChart.data.datasets[1].data = chartData.rmse_scores;

          performanceChart.update();
        }
      })
      .catch((error) => {
        console.error("ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
      });
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì°¨íŠ¸ ì´ˆê¸°í™”
  document.addEventListener("DOMContentLoaded", function () {
    initChart();
    initPnlChart();
    initLearningChart();
    initFeatureChart();

    // í•™ìŠµ ê°œì„ ì  ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    updateLearningChart();
    updateFeatureChart();

    // í•œê¸€ ì£¼ì„: PnL ì°¨íŠ¸ ìë™ ê°±ì‹  (60ì´ˆë§ˆë‹¤)
    setInterval(() => {
      try {
        updatePnlChart();
      } catch (e) {
        console.error("ìë™ ê°±ì‹  ì‹¤íŒ¨:", e);
      }
    }, 60000);
  });

  // ================================
  // 1ë…„ì¹˜ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê¸°ëŠ¥
  // ================================

  let backtestStatusInterval = null;

  // ë°±í…ŒìŠ¤íŠ¸ ì‹œì‘
  function startBacktest() {
    const symbol = document.getElementById("symbol-select").value;
    const chunkSize = parseInt(document.getElementById("chunk-size").value);
    const timeframe = document.getElementById("timeframe-select").value;

    // ì…ë ¥ê°’ ê²€ì¦
    if (chunkSize < 7 || chunkSize > 90) {
      alert("ì²­í¬ í¬ê¸°ëŠ” 7-90ì¼ ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.");
      return;
    }

    // UI ìƒíƒœ ë³€ê²½
    document.getElementById("start-backtest-btn").style.display = "none";
    document.getElementById("stop-backtest-btn").style.display = "block";
    document.getElementById("backtest-status").style.display = "block";
    document.getElementById("backtest-result").style.display = "none";

    // ë¡œê·¸ ì´ˆê¸°í™”
    clearLogs();
    addLog(
      `${symbol} 1ë…„ì¹˜ ë°±í…ŒìŠ¤íŠ¸ ì‹œì‘ (ì²­í¬: ${chunkSize}ì¼, ì‹œê°„í”„ë ˆì„: ${timeframe})`
    );

    // ë°±í…ŒìŠ¤íŠ¸ ì‹œì‘ API í˜¸ì¶œ
    fetch("/api/backtest/start", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        symbol: symbol,
        chunk_size: chunkSize,
        timeframe: timeframe,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          addLog(`âœ… ${data.message}`);
          // ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘
          backtestStatusInterval = setInterval(checkBacktestStatus, 2000);
        } else {
          addLog(`âŒ ì‹œì‘ ì‹¤íŒ¨: ${data.error}`);
          resetBacktestUI();
        }
      })
      .catch((error) => {
        console.error("ë°±í…ŒìŠ¤íŠ¸ ì‹œì‘ ì˜¤ë¥˜:", error);
        addLog(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
        resetBacktestUI();
      });
  }

  // ë°±í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨
  function stopBacktest() {
    if (confirm("ì •ë§ë¡œ ë°±í…ŒìŠ¤íŠ¸ë¥¼ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      fetch("/api/backtest/stop", {
        method: "POST",
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            addLog(`â¹ï¸ ${data.message}`);
          } else {
            addLog(`âŒ ì¤‘ë‹¨ ì‹¤íŒ¨: ${data.error}`);
          }
        })
        .catch((error) => {
          console.error("ë°±í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨ ì˜¤ë¥˜:", error);
          addLog(`âŒ ì¤‘ë‹¨ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`);
        });
    }
  }

  // ë°±í…ŒìŠ¤íŠ¸ ìƒíƒœ í™•ì¸
  function checkBacktestStatus() {
    fetch("/api/backtest/status")
      .then((response) => response.json())
      .then((data) => {
        if (data.success && data.status) {
          updateBacktestUI(data.status);

          // ì™„ë£Œë˜ê±°ë‚˜ ì˜¤ë¥˜ ë°œìƒì‹œ ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨
          if (!data.status.running) {
            clearInterval(backtestStatusInterval);
            backtestStatusInterval = null;

            if (data.status.result) {
              showBacktestResult(data.status.result);
            } else if (data.status.error) {
              addLog(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${data.status.error}`);
              resetBacktestUI();
            }
          }
        }
      })
      .catch((error) => {
        console.error("ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:", error);
      });
  }

  // ë°±í…ŒìŠ¤íŠ¸ UI ì—…ë°ì´íŠ¸
  function updateBacktestUI(status) {
    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    const progress = status.progress || 0;
    document.getElementById("progress-bar").style.width = progress + "%";
    document
      .getElementById("progress-bar")
      .setAttribute("aria-valuenow", progress);
    document.getElementById("progress-percent").textContent = progress + "%";

    // í˜„ì¬ ë‹¨ê³„ ì—…ë°ì´íŠ¸
    document.getElementById("step-text").textContent =
      status.current_step || "ì§„í–‰ ì¤‘...";

    // ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
    const statusBadge = document.getElementById("status-badge");
    if (status.running) {
      statusBadge.textContent = "ì‹¤í–‰ ì¤‘";
      statusBadge.className = "badge bg-primary ms-2";
    } else if (status.error) {
      statusBadge.textContent = "ì˜¤ë¥˜";
      statusBadge.className = "badge bg-danger ms-2";
    } else {
      statusBadge.textContent = "ì™„ë£Œ";
      statusBadge.className = "badge bg-success ms-2";
    }

    // ìƒˆë¡œìš´ ë¡œê·¸ ì¶”ê°€
    if (status.logs && status.logs.length > 0) {
      const currentLogCount =
        document.getElementById("backtest-logs").children.length;
      const newLogs = status.logs.slice(currentLogCount);

      newLogs.forEach((log) => {
        addLogDirect(log);
      });
    }
  }

  // ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ
  function showBacktestResult(result) {
    document.getElementById("backtest-status").style.display = "none";
    document.getElementById("backtest-result").style.display = "block";

    // ê²°ê³¼ ë°ì´í„° í‘œì‹œ
    document.getElementById("result-trades").textContent =
      (result.trades_generated || 0).toLocaleString() + "ê±´";
    document.getElementById("result-r2").textContent = (
      result.model_r2 || 0
    ).toFixed(3);
    document.getElementById("result-time").textContent =
      (result.execution_time_hours || 0).toFixed(1) + "ì‹œê°„";
    document.getElementById("result-winrate").textContent =
      (result.win_rate || 0).toFixed(1) + "%";

    addLog(
      `ğŸ‰ ë°±í…ŒìŠ¤íŠ¸ ì™„ë£Œ! ê±°ë˜ ${result.trades_generated || 0}ê±´ ìƒì„±, ëª¨ë¸ RÂ² ${(result.model_r2 || 0).toFixed(3)}`
    );

    resetBacktestUI();
  }

  // UI ë¦¬ì…‹
  function resetBacktestUI() {
    document.getElementById("start-backtest-btn").style.display = "block";
    document.getElementById("stop-backtest-btn").style.display = "none";

    if (backtestStatusInterval) {
      clearInterval(backtestStatusInterval);
      backtestStatusInterval = null;
    }
  }

  // ë¡œê·¸ ì¶”ê°€ (ì‹œê°„ í¬í•¨)
  function addLog(message) {
    const timestamp = new Date().toLocaleTimeString();
    const logMessage = `${timestamp} - ${message}`;
    addLogDirect(logMessage);
  }

  // ë¡œê·¸ ì§ì ‘ ì¶”ê°€
  function addLogDirect(logMessage) {
    const logsContainer = document.getElementById("backtest-logs");
    const logElement = document.createElement("div");
    logElement.textContent = logMessage;
    logElement.style.marginBottom = "2px";
    logsContainer.appendChild(logElement);

    // ìë™ ìŠ¤í¬ë¡¤
    logsContainer.scrollTop = logsContainer.scrollHeight;

    // ë¡œê·¸ ê°œìˆ˜ ì œí•œ (ìµœëŒ€ 100ê°œ)
    while (logsContainer.children.length > 100) {
      logsContainer.removeChild(logsContainer.firstChild);
    }
  }

  // ë¡œê·¸ ì´ˆê¸°í™”
  function clearLogs() {
    document.getElementById("backtest-logs").innerHTML = "";
  }

  // ê³ ê¸‰ ì„¤ì • í‘œì‹œ
  function showBacktestSettings() {
    alert(
      "ê³ ê¸‰ ì„¤ì • ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.\ní˜„ì¬ëŠ” ê¸°ë³¸ ì„¤ì •ë§Œ ì§€ì›í•©ë‹ˆë‹¤."
    );
  }

  // ë°±í…ŒìŠ¤íŠ¸ ê¸°ë¡ ë³´ê¸°
  function viewBacktestHistory() {
    alert("ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê¸°ë¡ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.");
  }

  // ìƒì„¸ ê²°ê³¼ ë³´ê¸°
  function viewDetailedResults() {
    // ìƒì„¸ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
    window.open("/detailed-results", "_blank");
  }

  // ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
  function downloadReport() {
    // ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ API í˜¸ì¶œ (êµ¬í˜„ í•„ìš”)
    alert("ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.");
  }
</script>
{% endblock %}
