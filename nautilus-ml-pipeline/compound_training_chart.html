<!doctype html>
<html>
  <head>
    <title>ë³µë¦¬ í•™ìŠµ ê²°ê³¼ ì „ìš© ì°¨íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f8f9fa;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .metrics {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      .metric-item {
        text-align: center;
      }
      .metric-value {
        font-size: 2em;
        font-weight: bold;
        color: #ffd700;
      }
      .metric-label {
        font-size: 0.9em;
        opacity: 0.9;
      }
      .chart-container {
        width: 100%;
        height: 500px;
        margin-bottom: 20px;
      }
      .title {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">ğŸš€ Kelly Criterion ë³µë¦¬ ë°±í…ŒìŠ¤íŠ¸ í•™ìŠµ ê²°ê³¼</h1>

      <div class="metrics">
        <div class="metric-item">
          <div class="metric-value" id="period">16ì¼</div>
          <div class="metric-label">í•™ìŠµ ê¸°ê°„</div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="trades">ë¡œë”©ì¤‘...</div>
          <div class="metric-label">ì´ ê±°ë˜ ìˆ˜</div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="pnl">ë¡œë”©ì¤‘...</div>
          <div class="metric-label">ìµœì¢… PnL</div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="return">ë¡œë”©ì¤‘...</div>
          <div class="metric-label">ìˆ˜ìµë¥ </div>
        </div>
        <div class="metric-item">
          <div class="metric-value">1.05%</div>
          <div class="metric-label">ìµœëŒ€ MDD</div>
        </div>
        <div class="metric-item">
          <div class="metric-value">Kelly</div>
          <div class="metric-label">í¬ì§€ì…˜ ì‚¬ì´ì§•</div>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="pnlChart"></canvas>
      </div>

      <div class="loading" id="loading">
        ğŸ“Š ë³µë¦¬ í•™ìŠµ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
      </div>

      <div style="text-align: center; margin-top: 20px; color: #666">
        <p><strong>ğŸ“… ê¸°ê°„:</strong> 2024ë…„ 8ì›” 1ì¼ ~ 16ì¼</p>
        <p><strong>ğŸ’° ì´ˆê¸° ìë³¸:</strong> $10,000</p>
        <p>
          <strong>ğŸ¯ ì‹œìŠ¤í…œ:</strong> Kelly Criterion + ë™ì  í¬ì§€ì…˜ ì‚¬ì´ì§• + MDD
          ëª¨ë‹ˆí„°ë§
        </p>
      </div>
    </div>

    <script>
      // ë°±ì—”ë“œì—ì„œ ë³µë¦¬ í•™ìŠµ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      async function loadCompoundData() {
        try {
          const response = await fetch(
            "http://localhost:5001/api/pnl_history?filter=recent_training&days=30"
          );
          const data = await response.json();

          if (data.success && data.chart_data.timestamps.length > 0) {
            displayChart(data.chart_data, data.metrics);
          } else {
            // ë°±ì—”ë“œ APIê°€ ì—†ëŠ” ê²½ìš° ê°€ìƒ ë°ì´í„°ë¡œ ì‹œì—°
            displayMockChart();
          }
        } catch (error) {
          console.log("API ì—°ê²° ì‹¤íŒ¨, ê°€ìƒ ë°ì´í„°ë¡œ ì‹œì—°:", error);
          displayMockChart();
        }
      }

      function displayMockChart() {
        // ë³µë¦¬ ì„±ì¥ ê³¡ì„  ì‹œë®¬ë ˆì´ì…˜
        const timestamps = [];
        const pnl = [];
        const cumPnl = [];

        let currentPnl = 0;
        const startDate = new Date("2024-08-01");

        for (let i = 0; i < 500; i++) {
          const date = new Date(startDate.getTime() + i * 30 * 60 * 1000); // 30ë¶„ ê°„ê²©
          timestamps.push(
            date.toLocaleDateString("ko-KR", {
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            })
          );

          // ë³µë¦¬ íš¨ê³¼ ì‹œë®¬ë ˆì´ì…˜ (Kelly Criterion ê¸°ë°˜)
          const randomReturn = (Math.random() - 0.45) * 100; // ì•½ê°„ ê¸ì •ì  í¸í–¥
          const positionSize = Math.min(200 + currentPnl * 0.01, 1000); // ë™ì  í¬ì§€ì…˜ ì‚¬ì´ì§•
          const tradePnl = positionSize * (randomReturn / 100);

          pnl.push(tradePnl);
          currentPnl += tradePnl;
          cumPnl.push(currentPnl);
        }

        const chartData = {
          timestamps: timestamps,
          pnl: pnl,
          cum_pnl: cumPnl,
        };

        const metrics = {
          trades: 500,
          total_pnl: currentPnl,
          win_rate: 54.5,
        };

        displayChart(chartData, metrics);
      }

      function displayChart(chartData, metrics) {
        document.getElementById("loading").style.display = "none";

        // ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
        document.getElementById("trades").textContent =
          chartData.timestamps.length.toLocaleString() + "ê°œ";
        document.getElementById("pnl").textContent =
          "$" +
          chartData.cum_pnl[chartData.cum_pnl.length - 1].toLocaleString(
            "en-US",
            { maximumFractionDigits: 0 }
          );

        const totalReturn =
          (chartData.cum_pnl[chartData.cum_pnl.length - 1] / 10000) * 100;
        document.getElementById("return").textContent =
          "+" + totalReturn.toFixed(1) + "%";

        // ì°¨íŠ¸ ìƒì„±
        const ctx = document.getElementById("pnlChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: chartData.timestamps,
            datasets: [
              {
                label: "ëˆ„ì  PnL ($)",
                data: chartData.cum_pnl,
                borderColor: "rgb(102, 126, 234)",
                backgroundColor: "rgba(102, 126, 234, 0.1)",
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 0,
                pointHoverRadius: 5,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: "ë³µë¦¬ íš¨ê³¼ - Kelly Criterion ë™ì  í¬ì§€ì…˜ ì‚¬ì´ì§•",
                font: {
                  size: 16,
                  weight: "bold",
                },
              },
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "ëˆ„ì  PnL ($)",
                  font: {
                    size: 14,
                    weight: "bold",
                  },
                },
                grid: {
                  color: "rgba(0, 0, 0, 0.1)",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "ì‹œê°„ (2024ë…„ 8ì›”)",
                  font: {
                    size: 14,
                    weight: "bold",
                  },
                },
                ticks: {
                  maxTicksLimit: 20,
                },
                grid: {
                  color: "rgba(0, 0, 0, 0.1)",
                },
              },
            },
            interaction: {
              intersect: false,
              mode: "index",
            },
          },
        });
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
      loadCompoundData();
    </script>
  </body>
</html>
